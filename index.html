<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>HackBall</title>
  <style>
    html, body { margin: 0; padding: 0; overflow: hidden; background: #121212; color: white; font-family: sans-serif; }
    canvas { background: green; display: block; margin: 0 auto; }
    #gui {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px;
      display: flex; flex-direction: column; gap: 10px; width: 300px; text-align: center;
    }
    #escMenu {
      position: absolute; top: 10%; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.95); padding: 20px; border-radius: 10px; display: none;
      min-width: 300px;
    }
    .playerRow { display: flex; justify-content: space-between; align-items: center; margin: 5px 0; }
    button { padding: 6px 10px; border: none; border-radius: 5px; cursor: pointer; }
    .teamRed { background: crimson; }
    .teamBlue { background: dodgerblue; }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="960" height="540"></canvas>

  <div id="gui">
    <input id="nick" placeholder="Nickiniz" />
    <input id="partyId" placeholder="Parti ID (varsa)" />
    <button id="createParty">Parti Olu≈ütur</button>
    <button id="joinParty">Partiye Katƒ±l</button>
  </div>

  <div id="escMenu">
    <h3>Parti Kontrol Paneli</h3>
    <div id="playerList"></div>
    <p>Parti ID: <span id="partyDisplay"></span></p>
    <button onclick="closeMenu()">Kapat</button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let players = {}, ball = null, myId = null, leader = false;
    let keys = {};

    // Giri≈ü GUI
    document.getElementById('createParty').onclick = () => {
      const nick = document.getElementById('nick').value.trim();
      if (!nick) return;
      socket.emit('create', nick);
      document.getElementById('gui').style.display = 'none';
    };
    document.getElementById('joinParty').onclick = () => {
      const nick = document.getElementById('nick').value.trim();
      const id = document.getElementById('partyId').value.trim();
      if (!nick || !id) return;
      socket.emit('join', { nick, id });
      document.getElementById('gui').style.display = 'none';
    };

    document.addEventListener('keydown', e => {
      keys[e.code] = true;
      if (e.code === 'Escape') toggleMenu();
    });
    document.addEventListener('keyup', e => {
      keys[e.code] = false;
    });

    function toggleMenu() {
      if (!leader) return;
      const menu = document.getElementById('escMenu');
      menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    }

    function closeMenu() {
      document.getElementById('escMenu').style.display = 'none';
    }

    socket.on('init', ({ id, teamLeader }) => {
      myId = id;
      leader = teamLeader;
    });

    socket.on('state', data => {
      players = data.players;
      ball = data.ball;
      draw();
      updateMenu();
    });

    function updateMenu() {
      const list = document.getElementById('playerList');
      list.innerHTML = '';
      for (let id in players) {
        const p = players[id];
        const row = document.createElement('div');
        row.className = 'playerRow';
        row.innerHTML = `
          <span style="color:${p.color}">${p.name}${p.leader ? ' üëë' : ''}</span>
          <div>
            <button class="teamRed" onclick="changeTeam('${id}','red')">K</button>
            <button class="teamBlue" onclick="changeTeam('${id}','blue')">M</button>
            <button onclick="kick('${id}')">‚ùå</button>
          </div>`;
        list.appendChild(row);
      }
      document.getElementById('partyDisplay').innerText = location.hash.slice(1);
    }

    function changeTeam(id, team) {
      socket.emit('changeTeam', { id, team });
    }

    function kick(id) {
      socket.emit('kick', id);
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (!ball) return;

      // Saha
      ctx.fillStyle = 'green';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Top
      ctx.fillStyle = 'white';
      ctx.beginPath();
      ctx.arc(ball.x, ball.y, 10, 0, Math.PI * 2);
      ctx.fill();

      // Oyuncular
      for (let id in players) {
        const p = players[id];
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(p.x, p.y, 15, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = 'white';
        ctx.fillText(p.name, p.x - 15, p.y - 20);
      }
    }

    setInterval(() => {
      socket.emit('input', keys);
    }, 1000 / 50);
  </script>
</body>
</html>
