<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>HackBall</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: sans-serif;
      background: #222;
      color: white;
    }
    #gui, #escMenu {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 300px;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      padding: 20px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    #escMenu { display: none; }

    canvas {
      display: block;
    }

    button, input {
      padding: 8px;
      border: none;
      border-radius: 5px;
    }
    #gameInfo {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.6);
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
    }
  </style>
</head>
<body>

<div id="gui">
  <input id="nameInput" placeholder="AdÄ±nÄ±z" />
  <input id="partyIdInput" placeholder="Parti ID (katÄ±lmak iÃ§in)" />
  <select id="teamSelect">
    <option value="red">KÄ±rmÄ±zÄ±</option>
    <option value="blue">Mavi</option>
  </select>
  <button onclick="createParty()">Parti OluÅŸtur</button>
  <button onclick="joinParty()">Partiye KatÄ±l</button>
</div>

<div id="escMenu">
  <h3>ESC MenÃ¼sÃ¼</h3>
  <div id="partyIdDisplay"></div>
  <div id="playerList"></div>
  <button onclick="hideEsc()">MenÃ¼yÃ¼ Kapat</button>
</div>

<canvas id="gameCanvas" width="800" height="600"></canvas>
<div id="gameInfo"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
let playerId = null;
let party = null;
let keys = {};
let myPlayer = null;

document.addEventListener("keydown", (e) => {
  keys[e.key] = true;
  if (e.key === "Escape") toggleEsc();
});
document.addEventListener("keyup", (e) => keys[e.key] = false);

function createParty() {
  const name = document.getElementById("nameInput").value;
  const team = document.getElementById("teamSelect").value;
  socket.emit("createParty", { name, team });
  document.getElementById("gui").style.display = "none";
}

function joinParty() {
  const name = document.getElementById("nameInput").value;
  const team = document.getElementById("teamSelect").value;
  const partyId = document.getElementById("partyIdInput").value.trim().toUpperCase();
  socket.emit("joinParty", { name, team, partyId });
  document.getElementById("gui").style.display = "none";
}

function toggleEsc() {
  const esc = document.getElementById("escMenu");
  esc.style.display = esc.style.display === "none" ? "block" : "none";
  updateEscMenu();
}

function hideEsc() {
  document.getElementById("escMenu").style.display = "none";
}

function updateEscMenu() {
  if (!party) return;
  document.getElementById("partyIdDisplay").innerText = "Parti ID: " + party.id;
  const list = Object.values(party.players).map(p => {
    const isLeader = p.isLeader ? " ðŸ‘‘" : "";
    return `<div>${p.name} [${p.team}]${isLeader}</div>`;
  }).join("");
  document.getElementById("playerList").innerHTML = list;
}

socket.on("partyData", (data) => {
  party = data;
  playerId = socket.id;
  myPlayer = party.players[playerId];
  updateEscMenu();
});

socket.on("kicked", () => {
  alert("Partiden atÄ±ldÄ±nÄ±z.");
  location.reload();
});

socket.on("matchEnd", () => {
  alert("MaÃ§ bitti! 6 dakika doldu.");
});

let lastTime = 0;
function gameLoop(timestamp) {
  requestAnimationFrame(gameLoop);
  if (!party || !myPlayer) return;

  const dt = (timestamp - lastTime) / 1000;
  lastTime = timestamp;

  // Oyuncu hareketi
  let speed = 200;
  if (keys["Shift"]) speed *= 1.5;

  if (keys["w"] || keys["ArrowUp"]) myPlayer.y -= speed * dt;
  if (keys["s"] || keys["ArrowDown"]) myPlayer.y += speed * dt;
  if (keys["a"] || keys["ArrowLeft"]) myPlayer.x -= speed * dt;
  if (keys["d"] || keys["ArrowRight"]) myPlayer.x += speed * dt;

  // SÄ±nÄ±rlar
  myPlayer.x = Math.max(0, Math.min(800, myPlayer.x));
  myPlayer.y = Math.max(0, Math.min(600, myPlayer.y));

  socket.emit("move", { x: myPlayer.x, y: myPlayer.y });

  // Topa vurma
  if (keys[" "] || keys["0"]) {
    const dx = party.ball.x - myPlayer.x;
    const dy = party.ball.y - myPlayer.y;
    const dist = Math.sqrt(dx*dx + dy*dy);
    if (dist < 50) {
      const forceX = -dx / dist * 5;
      const forceY = -dy / dist * 5;
      socket.emit("kickBall", { forceX, forceY });
    }
  }
}

socket.on("gameState", (data) => {
  party = data;
  myPlayer = party.players[playerId];
  drawGame();
});

function drawGame() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Saha Ã§iz
  ctx.fillStyle = "#3a3a3a";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Top Ã§iz
  const ball = party.ball;
  ctx.fillStyle = "white";
  ctx.beginPath();
  ctx.arc(ball.x, ball.y, 10, 0, Math.PI * 2);
  ctx.fill();

  // Oyuncular
  for (let id in party.players) {
    const p = party.players[id];
    ctx.fillStyle = p.team === "red" ? "red" : "blue";
    ctx.beginPath();
    ctx.arc(p.x, p.y, 15, 0, Math.PI * 2);
    ctx.fill();

    ctx.fillStyle = "white";
    ctx.font = "12px sans-serif";
    ctx.fillText(p.name, p.x - 15, p.y - 20);
  }
}

requestAnimationFrame(gameLoop);
</script>
</body>
</html>
