<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>HackBall</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body, html { width: 100%; height: 100%; font-family: sans-serif; background: #222; color: white; overflow: hidden; }

    canvas { display: block; margin: auto; background: green; border: 4px solid white; }

    #gui, #escMenu {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.8); display: flex;
      align-items: center; justify-content: center; flex-direction: column;
    }

    #gui input, #gui button, #escMenu button {
      margin: 10px; padding: 10px 20px; font-size: 16px;
    }

    #escMenu {
      display: none;
      text-align: center;
    }

    .playerList {
      background: #333; padding: 10px; border-radius: 5px;
      margin: 5px 0;
    }

    .teamBtn { margin-left: 10px; cursor: pointer; }
  </style>
</head>
<body>

  <div id="gui">
    <h1>HackBall</h1>
    <input id="nickname" placeholder="Nickiniz" />
    <button onclick="createParty()">ðŸŽ‰ Parti OluÅŸtur</button>
    <input id="joinCode" placeholder="Parti ID'si" />
    <button onclick="joinParty()">ðŸ”— Partiye KatÄ±l</button>
  </div>

  <div id="escMenu">
    <h2>Parti MenÃ¼sÃ¼</h2>
    <div id="partyIdDisplay"></div>
    <div id="players"></div>
    <button onclick="closeEscMenu()">ESC ile kapat</button>
  </div>

  <canvas id="gameCanvas" width="960" height="540"></canvas>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    const socket = io();
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let nickname = "";
    let isLeader = false;
    let playerId = "";
    let partyId = "";
    let players = [];
    let ball = { x: 480, y: 270, vx: 0, vy: 0 };
    const radius = 20;

    function createParty() {
      nickname = document.getElementById('nickname').value;
      socket.emit('createParty', nickname);
    }

    function joinParty() {
      nickname = document.getElementById('nickname').value;
      const code = document.getElementById('joinCode').value;
      socket.emit('joinParty', { nickname, code });
    }

    function closeEscMenu() {
      document.getElementById('escMenu').style.display = 'none';
    }

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        document.getElementById('escMenu').style.display = 'flex';
      }
    });

    socket.on('joined', data => {
      partyId = data.partyId;
      playerId = data.id;
      isLeader = data.isLeader;
      document.getElementById('gui').style.display = 'none';
      document.getElementById('partyIdDisplay').innerText = "Parti ID: " + partyId;
    });

    socket.on('updateState', state => {
      players = state.players;
      ball = state.ball;
      updatePlayerList(state.players);
    });

    function updatePlayerList(players) {
      const container = document.getElementById('players');
      container.innerHTML = '';
      players.forEach(p => {
        const div = document.createElement('div');
        div.className = 'playerList';
        div.innerText = `${p.nickname} (${p.team})`;
        if (isLeader && p.id !== playerId) {
          const redBtn = document.createElement('button');
          redBtn.innerText = "KÄ±rmÄ±zÄ±";
          redBtn.onclick = () => socket.emit('changeTeam', { id: p.id, team: "red" });

          const blueBtn = document.createElement('button');
          blueBtn.innerText = "Mavi";
          blueBtn.onclick = () => socket.emit('changeTeam', { id: p.id, team: "blue" });

          const kickBtn = document.createElement('button');
          kickBtn.innerText = "At ðŸ—‘";
          kickBtn.onclick = () => socket.emit('kick', p.id);

          div.appendChild(redBtn);
          div.appendChild(blueBtn);
          div.appendChild(kickBtn);
        }
        container.appendChild(div);
      });
    }

    let keys = {};
    document.addEventListener('keydown', e => keys[e.key] = true);
    document.addEventListener('keyup', e => keys[e.key] = false);

    function gameLoop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Draw ball
      ctx.fillStyle = 'white';
      ctx.beginPath();
      ctx.arc(ball.x, ball.y, 12, 0, Math.PI * 2);
      ctx.fill();

      // Draw players
      players.forEach(p => {
        ctx.fillStyle = p.team === "red" ? "red" : "blue";
        ctx.beginPath();
        ctx.arc(p.x, p.y, radius, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = "white";
        ctx.fillText(p.nickname, p.x - radius, p.y + radius + 12);
      });

      // Send input
      socket.emit('input', keys);

      requestAnimationFrame(gameLoop);
    }

    gameLoop();
  </script>
</body>
</html>
