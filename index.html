<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>HackBall Multiplayer</title>
<style>
  body { margin:0; background:#111; color:white; font-family:sans-serif; text-align:center; }
  #lobby, #roomDisplay { padding-top:50px; }
  #game { display:none; margin:20px auto; background:#222; border:2px solid #fff; }
  input, button {
    padding:10px; margin:10px; font-size:16px; border-radius:8px; border:none; cursor:pointer;
  }
  #adminMenu {
    display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%);
    background:#333; padding:20px; border:2px solid lime; border-radius:10px; z-index:100;
  }
</style>
</head>
<body>

<div id="lobby">
  <h1>âš½ HackBall'a HoÅŸ Geldin</h1>
  <input id="nickname" placeholder="Takma adÄ±nÄ± yaz" /><br />
  <input id="roomId" placeholder="Parti ID gir (Ã¶rnek: abc123)" /><br />
  <button onclick="create()">Yeni Parti OluÅŸtur</button>
  <button onclick="join()">KatÄ±l</button>
</div>

<div id="roomDisplay" style="display:none;">
  <h2>ðŸ“Œ Parti OluÅŸturuldu</h2>
  <p>Parti ID: <span id="roomCode"></span></p>
  <button onclick="start()">Oyunu BaÅŸlat</button>
</div>

<canvas id="game" width="600" height="400"></canvas>

<div id="adminMenu">
  <h3>ðŸŽ› YÃ¶netici Paneli (Host)</h3>
  <p>ID: <span id="adminRoomId"></span></p>
  <div id="playersAdmin"></div>
  <button onclick="closeAdmin()">Kapat</button>
</div>

<script>
const c = document.getElementById('game');
const ctx = c.getContext('2d');
const WIDTH = 600, HEIGHT = 400, GOAL = 100;

let ws, players = [], ball = {}, scores = {}, myId = '', isHost = false, roomId = '';

function create() {
  const nick = document.getElementById('nickname').value.trim();
  if (!nick) return alert('Takma ad gerekli');
  roomId = Math.random().toString(36).substr(2, 6);
  isHost = true;
  document.getElementById('lobby').style.display = 'none';
  document.getElementById('roomDisplay').style.display = 'block';
  document.getElementById('roomCode').innerText = roomId;
}

function join() {
  const nick = document.getElementById('nickname').value.trim();
  const rid = document.getElementById('roomId').value.trim();
  if (!nick || !rid) return alert('Ad ve ID gir');
  roomId = rid;
  isHost = false;
  document.getElementById('lobby').style.display = 'none';
  document.getElementById('game').style.display = 'block';
  connect();
}

function start() {
  document.getElementById('roomDisplay').style.display = 'none';
  document.getElementById('game').style.display = 'block';
  connect();
  if (isHost) document.getElementById('adminMenu').style.display = 'block';
}

function connect() {
  ws = new WebSocket('wss://hackball-server.onrender.com');
  ws.onopen = () => {
    ws.send(JSON.stringify({ type: 'join', nickname: document.getElementById('nickname').value.trim(), roomId, isHost }));
  };
  ws.onmessage = e => {
    const d = JSON.parse(e.data);
    if (d.type === 'error') {
      alert(d.message);
      location.reload();
      return;
    }
    if (d.type === 'init') myId = d.id;
    if (d.type === 'gameState') {
      players = d.players;
      ball = d.ball;
      scores = d.scores;
      if (isHost) updateAdmin();
    }
  };
  ws.onclose = () => {
    alert('Sunucu baÄŸlantÄ±sÄ± kesildi!');
    location.reload();
  };
  window.addEventListener('keydown', e => {
    if (ws.readyState !== 1) return;
    let dir = null;
    if (['w', 'a', 's', 'd'].includes(e.key)) {
      dir = e.key === 'a' ? 'left' : e.key === 'd' ? 'right' : e.key === 'w' ? 'up' : 'down';
    }
    if (dir) ws.send(JSON.stringify({ type: 'move', dir }));
    if (e.code === 'Space') ws.send(JSON.stringify({ type: 'kick' }));
    if (e.key === 'Escape' && isHost) {
      const m = document.getElementById('adminMenu');
      m.style.display = m.style.display === 'none' ? 'block' : 'none';
    }
  });
  requestAnimationFrame(draw);
}

function updateAdmin() {
  document.getElementById('adminRoomId').innerText = roomId;
  const div = document.getElementById('playersAdmin');
  div.innerHTML = '';
  players.forEach(p => {
    const el = document.createElement('div');
    el.innerHTML = `
      ${p.nickname} (TakÄ±m ${p.team})
      <button onclick="changeTeam('${p.id}')">TakÄ±m DeÄŸiÅŸtir</button>
      <button onclick="kickPlayer('${p.id}')">At</button>
    `;
    div.appendChild(el);
  });
}

function changeTeam(id) {
  ws.send(JSON.stringify({ type: 'changeTeam', target: id }));
}

function kickPlayer(id) {
  ws.send(JSON.stringify({ type: 'kickPlayer', target: id }));
}

function closeAdmin() {
  document.getElementById('adminMenu').style.display = 'none';
}

function draw() {
  ctx.clearRect(0, 0, WIDTH, HEIGHT);

  // Kale Ã§izimi
  ctx.fillStyle = 'gray';
  ctx.fillRect(0, HEIGHT / 2 - GOAL / 2, 10, GOAL);
  ctx.fillRect(WIDTH - 10, HEIGHT / 2 - GOAL / 2, 10, GOAL);

  // Skorlar
  ctx.fillStyle = 'white';
  ctx.font = '20px Arial';
  ctx.fillText(`KIRMIZI: ${scores.team1}`, 50, 30);
  ctx.fillText(`MAVÄ°: ${scores.team2}`, WIDTH - 150, 30);

  // Top
  ctx.fillStyle = 'white';
  ctx.beginPath();
  ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
  ctx.fill();

  // Oyuncular
  ctx.font = '14px Arial';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'top';
  players.forEach(p => {
    ctx.fillStyle = p.team === 1 ? 'red' : 'blue';
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
    ctx.fill();

    ctx.fillStyle = 'white';
    // Ä°sim tam oyuncunun altÄ±na ortalÄ± ÅŸekilde
    ctx.fillText(p.nickname, p.x, p.y + p.radius + 4);
  });

  requestAnimationFrame(draw);
}
</script>
</body>
</html>
