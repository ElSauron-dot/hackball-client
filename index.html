<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>HackBall Multiplayer</title>
  <style>
    body { margin: 0; background: #111; color: white; font-family: sans-serif; text-align: center; }
    #lobby, #roomDisplay { padding-top: 50px; }
    #game { display: none; margin: 20px auto; background: #222; border: 2px solid #fff; position: relative; }
    input, select, button { padding: 10px; margin: 10px; font-size: 16px; border-radius: 8px; border: none; }
    button { cursor: pointer; }
  </style>
</head>
<body>

<div id="lobby">
  <h1>⚽ HackBall'a Hoş Geldin</h1>
  <input type="text" id="nickname" placeholder="Takma adını yaz"><br />
  <select id="teamSelect">
    <option value="">Takımını seç</option>
    <option value="red">Kırmızı (solda)</option>
    <option value="blue">Mavi (sağda)</option>
  </select><br />
  <input type="text" id="roomId" placeholder="Parti ID gir (örnek: abc123)"><br />
  <button onclick="joinGame()">Katıl</button>
  <button onclick="createRoom()">Yeni Parti Oluştur</button>
</div>

<div id="roomDisplay" style="display:none;">
  <h2>✅ Parti oluşturuldu!</h2>
  <p>Bu parti ID'sini arkadaşlarınla paylaş:</p>
  <h1 id="roomCodeDisplay" style="font-size: 36px; color: lime;"></h1>
  <button onclick="startHostGame()">Oyunu Başlat</button>
</div>

<canvas id="game" width="600" height="400"></canvas>
<p id="timer" style="color:white; font-size:18px;"></p>

<script>
  let nickname = '', roomId = '', team = '';
  let ws, players = {}, ball = { x: 300, y: 200 };
  let gameStartTime = null;

  function createRoom() {
    nickname = document.getElementById('nickname').value.trim();
    team = document.getElementById('teamSelect').value;
    if (!nickname || !team) return alert("Takma ad ve takım seçin");

    roomId = Math.random().toString(36).substring(2, 8);
    document.getElementById('lobby').style.display = 'none';
    document.getElementById('roomDisplay').style.display = 'block';
    document.getElementById('roomCodeDisplay').innerText = roomId;
  }

  function startHostGame() {
    connectWebSocket();
    document.getElementById('roomDisplay').style.display = 'none';
    document.getElementById('game').style.display = 'block';
    gameStartTime = Date.now();
  }

  function joinGame() {
    nickname = document.getElementById('nickname').value.trim();
    team = document.getElementById('teamSelect').value;
    roomId = document.getElementById('roomId').value.trim();
    if (!nickname || !team || !roomId) return alert("Takma ad, takım ve parti ID gir");

    connectWebSocket();
    document.getElementById('lobby').style.display = 'none';
    document.getElementById('game').style.display = 'block';
  }

  function connectWebSocket() {
    ws = new WebSocket('wss://hackball-server.onrender.com');

    ws.onopen = () => {
      ws.send(JSON.stringify({ type: 'join', nickname, roomId, team }));
    };

    ws.onmessage = event => {
      const data = JSON.parse(event.data);
      if (data.type === 'error') {
        alert(data.message);
        location.reload();
        return;
      }
      if (data.type === 'gameState') {
        players = {};
        data.players.forEach(p => { players[p.playerId] = p; });
        ball = data.ball;
      }
    };

    ws.onclose = () => {
      alert('Sunucu bağlantısı kesildi!');
      location.reload();
    };

    window.addEventListener('keydown', e => {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      let dir = null;
      if (e.key === 'ArrowLeft') dir = 'left';
      else if (e.key === 'ArrowRight') dir = 'right';
      else if (e.key === 'ArrowUp') dir = 'up';
      else if (e.key === 'ArrowDown') dir = 'down';
      if (dir) ws.send(JSON.stringify({ type: 'move', dir }));
    });

    draw();
  }

  function draw() {
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    ctx.fillStyle = 'white';
    ctx.beginPath(); ctx.arc(ball.x, ball.y, 10, 0, Math.PI * 2); ctx.fill();

    ctx.font = '14px Arial'; ctx.textAlign = 'center';
    for (let id in players) {
      let p = players[id];
      ctx.fillStyle = p.team === 'red' ? 'red' : 'blue';
      ctx.beginPath(); ctx.arc(p.x, p.y, 15, 0, Math.PI * 2); ctx.fill();
      ctx.fillStyle = 'white'; ctx.fillText(p.nickname, p.x, p.y + 30);
    }

    if (gameStartTime) {
      const elapsed = Math.floor((Date.now() - gameStartTime) / 1000);
      const remaining = Math.max(0, 360 - elapsed);
      document.getElementById('timer').innerText = `Kalan süre: ${remaining}s`;
      if (remaining <= 0) {
        alert("Maç sona erdi!");
        location.reload();
        return;
      }
    }

    requestAnimationFrame(draw);
  }
</script>

</body>
</html>
